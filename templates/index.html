{% extends "base.html" %}
{% block title %}Todo List{% endblock %}
{% block content %}
<div class="row g-4">
  <!-- Form tạo task -->
  <div class="col-12 col-lg-5">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <h2 class="h5 mb-3">Add a new task</h2>
        <form method="post" action="{{ url_for('create_task') }}">
          <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input type="text" class="form-control" id="title" name="title" required />
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" id="status" name="status">
              <option value="pending" selected>Pending</option>
              <option value="done">Done</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i>
            Create task
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Danh sách task -->
  <div class="col-12 col-lg-7">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-header bg-white border-0 pb-0">
        <h2 class="h5 mb-0">Tasks</h2>
      </div>

      <!-- list -->
      <div class="list-group list-group-flush {% if not tasks %}d-none{% endif %}" id="tasksList">
        {% for task in tasks %}
        <div
          class="list-group-item task-item"
          data-task-id="{{ task.id }}"
          data-task-title="{{ task.title | e }}"
          data-task-description="{{ task.description | default('', true) | e }}"
          data-task-status="{{ task.status }}"
        >
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold task-title">{{ task.title }}</div>
              <p class="text-muted mb-2 small task-description">
                {{ task.description or 'No description' }}
              </p>
            </div>
            <small class="text-muted ms-3">
              {{ task.created_at.strftime('%Y-%m-%d %H:%M') if task.created_at }}
            </small>
          </div>

          <div class="d-flex flex-wrap align-items-center gap-2">
            {% set badge_classes = 'text-bg-success' if task.status == 'done' else 'text-bg-warning text-dark' %}
            <span class="badge text-uppercase task-status-badge {{ badge_classes }}">
              {{ 'Done' if task.status == 'done' else 'Pending' }}
            </span>

            <!-- Edit via modal -->
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary"
              data-bs-toggle="modal"
              data-bs-target="#editTaskModal"
              data-action="edit"
            >
              <i class="bi bi-pencil-square me-1"></i>
              Edit
            </button>

            <!-- Mark done (form post truyền thống) -->
            <div class="mark-done-container {% if task.status == 'done' %}d-none{% endif %}">
              <form method="post" action="{{ url_for('update_task', task_id=task.id) }}" class="d-inline">
                <input type="hidden" name="title" value="{{ task.title | default('', true) | e }}" />
                <input type="hidden" name="description" value="{{ task.description | default('', true) | e }}" />
                <input type="hidden" name="status" value="done" />
                <button type="submit" class="btn btn-sm btn-outline-success">
                  <i class="bi bi-check2 me-1"></i>
                  Mark done
                </button>
              </form>
            </div>

            <!-- Delete via modal -->
            <button
              type="button"
              class="btn btn-sm btn-outline-danger"
              data-bs-toggle="modal"
              data-bs-target="#deleteTaskModal"
              data-action="delete"
            >
              <i class="bi bi-trash me-1"></i>
              Delete
            </button>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- empty state -->
      <div class="card-body {% if tasks %}d-none{% endif %}" id="emptyState">
        <p class="text-muted mb-0">No tasks yet. Add one above!</p>
      </div>
    </div>
  </div>
</div>

<!-- Edit modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editTaskForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="editTaskTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="editTaskTitle" name="title" required />
          </div>
          <div class="mb-3">
            <label for="editTaskDescription" class="form-label">Description</label>
            <textarea class="form-control" id="editTaskDescription" name="description" rows="3"></textarea>
          </div>
          <div class="mb-0">
            <label for="editTaskStatus" class="form-label">Status</label>
            <select class="form-select" id="editTaskStatus" name="status">
              <option value="pending">Pending</option>
              <option value="done">Done</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="saveTaskButton">
            <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
            <span class="button-text">Save changes</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete modal -->
<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">Are you sure you want to delete this task?</p>
        <p class="fw-semibold mt-2" id="deleteTaskTitle"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteButton">
          <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
          <span class="button-text">Delete</span>
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const editModalEl = document.getElementById("editTaskModal");
    const deleteModalEl = document.getElementById("deleteTaskModal");
    const editModal = editModalEl ? bootstrap.Modal.getOrCreateInstance(editModalEl) : null;
    const deleteModal = deleteModalEl ? bootstrap.Modal.getOrCreateInstance(deleteModalEl) : null;

    const editForm = document.getElementById("editTaskForm");
    const editTitleInput = document.getElementById("editTaskTitle");
    const editDescriptionInput = document.getElementById("editTaskDescription");
    const editStatusSelect = document.getElementById("editTaskStatus");
    const saveTaskButton = document.getElementById("saveTaskButton");

    const deleteTaskTitle = document.getElementById("deleteTaskTitle");
    const confirmDeleteButton = document.getElementById("confirmDeleteButton");

    const tasksList = document.getElementById("tasksList");
    const emptyState = document.getElementById("emptyState");

    let currentTaskId = null;

    function toggleButtonLoading(button, isLoading) {
      if (!button) return;
      const spinner = button.querySelector(".spinner-border");
      const text = button.querySelector(".button-text");
      if (spinner) spinner.classList.toggle("d-none", !isLoading);
      if (text) text.classList.toggle("d-none", isLoading);
      button.disabled = isLoading;
    }

    function updateEmptyStateVisibility() {
      if (!tasksList || !emptyState) return;
      const hasItems = tasksList.querySelectorAll(".task-item").length > 0;
      tasksList.classList.toggle("d-none", !hasItems);
      emptyState.classList.toggle("d-none", hasItems);
    }

    function hydrateTaskData(taskEl, data) {
      if (!taskEl) return;
      taskEl.dataset.taskTitle = data.title || "";
      taskEl.dataset.taskDescription = data.description || "";
      taskEl.dataset.taskStatus = data.status || "pending";

      const titleEl = taskEl.querySelector(".task-title");
      const descEl = taskEl.querySelector(".task-description");
      const badgeEl = taskEl.querySelector(".task-status-badge");
      const markDoneWrap = taskEl.querySelector(".mark-done-container");

      if (titleEl) titleEl.textContent = data.title;
      if (descEl) descEl.textContent = data.description || "No description";
      if (badgeEl) {
        badgeEl.textContent = data.status === "done" ? "Done" : "Pending";
        badgeEl.classList.remove("text-bg-success", "text-bg-warning", "text-dark");
        if (data.status === "done") {
          badgeEl.classList.add("text-bg-success");
        } else {
          badgeEl.classList.add("text-bg-warning", "text-dark");
        }
      }
      if (markDoneWrap) markDoneWrap.classList.toggle("d-none", data.status === "done");
    }

    // open edit modal
    document.querySelectorAll(".task-item [data-action='edit']").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const taskEl = e.currentTarget.closest(".task-item");
        if (!taskEl) return;
        currentTaskId = taskEl.dataset.taskId;
        editTitleInput.value = taskEl.dataset.taskTitle || "";
        editDescriptionInput.value = taskEl.dataset.taskDescription || "";
        editStatusSelect.value = taskEl.dataset.taskStatus || "pending";
      });
    });

    // open delete modal
    document.querySelectorAll(".task-item [data-action='delete']").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const taskEl = e.currentTarget.closest(".task-item");
        if (!taskEl) return;
        currentTaskId = taskEl.dataset.taskId;
        deleteTaskTitle.textContent = taskEl.dataset.taskTitle || "";
      });
    });

    // submit edit via JSON
    if (editForm) {
      editForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!currentTaskId) return;
        toggleButtonLoading(saveTaskButton, true);
        try {
          const res = await fetch(`/api/tasks/${currentTaskId}/update`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              title: editTitleInput.value,
              description: editDescriptionInput.value,
              status: editStatusSelect.value,
            }),
          });
          let data = null;
          try { data = await res.json(); } catch { window.todoApp?.showAlert("Unexpected response from the server.", "danger"); return; }
          if (!res.ok || !data.ok) {
            window.todoApp?.showAlert(data.error || "Failed to update the task.", "danger");
            return;
          }
          const taskEl = document.querySelector(`.task-item[data-task-id='${currentTaskId}']`);
          hydrateTaskData(taskEl, data.task);
          window.todoApp?.showAlert("Task updated successfully!", "success");
          editModal?.hide();
          currentTaskId = null;
        } catch {
          window.todoApp?.showAlert("Network error. Please try again.", "danger");
        } finally {
          toggleButtonLoading(saveTaskButton, false);
        }
      });
    }

    // confirm delete via JSON
    if (confirmDeleteButton) {
      confirmDeleteButton.addEventListener("click", async () => {
        if (!currentTaskId) return;
        toggleButtonLoading(confirmDeleteButton, true);
        try {
          const res = await fetch(`/api/tasks/${currentTaskId}/delete`, { method: "POST" });
          let data = null;
          try { data = await res.json(); } catch { window.todoApp?.showAlert("Unexpected response from the server.", "danger"); return; }
          if (!res.ok || !data.ok) {
            window.todoApp?.showAlert(data.error || "Failed to delete the task.", "danger");
            return;
          }
          const taskEl = document.querySelector(`.task-item[data-task-id='${currentTaskId}']`);
          if (taskEl) {
            taskEl.remove();
            updateEmptyStateVisibility();
          }
          window.todoApp?.showAlert("Task deleted.", "info");
          deleteModal?.hide();
          currentTaskId = null;
        } catch {
          window.todoApp?.showAlert("Network error. Please try again.", "danger");
        } finally {
          toggleButtonLoading(confirmDeleteButton, false);
        }
      });
    }

    updateEmptyStateVisibility();
  });
</script>
{% endblock %}
