{% extends "base.html" %}
{% block title %}Todo List{% endblock %}
{% block content %}
<div class="row g-4">
  <div class="col-12 col-lg-5">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <h2 class="h5 mb-3">Add a new task</h2>
        <form method="post" action="{{ url_for('create_task') }}">
          <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input type="text" class="form-control" id="title" name="title" required />
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" id="status" name="status">
              <option value="pending" selected>Pending</option>
              <option value="done">Done</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i>
            Create task
          </button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-7">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-header border-0 pb-0">
        <h2 class="h5 mb-0">Tasks</h2>
      </div>
      <div class="card-body pb-0">
        <div class="row g-2 g-sm-3 align-items-center">
          <div class="col-12 col-sm">
            <div class="input-group shadow-sm">
              <span class="input-group-text bg-body-secondary border-0">
                <i class="bi bi-search"></i>
              </span>
              <input
                type="search"
                class="form-control border-0"
                id="taskSearchInput"
                placeholder="Search tasks"
                aria-label="Search tasks by title or description"
              />
            </div>
          </div>
          <div class="col-12 col-sm-auto">
            <label for="taskStatusFilter" class="form-label visually-hidden">Filter by status</label>
            <select class="form-select shadow-sm" id="taskStatusFilter" aria-label="Filter by task status">
              <option value="all" selected>All statuses</option>
              <option value="pending">Pending</option>
              <option value="done">Done</option>
            </select>
          </div>
        </div>
      </div>
      <div class="list-group list-group-flush {% if not tasks %}d-none{% endif %}" id="tasksList">
        {% for task in tasks %}
        <div
          class="list-group-item task-item"
          data-task-id="{{ task.id }}"
          data-task-title="{{ task.title | e }}"
          data-task-description="{{ task.description | default('', true) | e }}"
          data-task-status="{{ task.status }}"
          data-task-created-at="{{ task.created_at.isoformat() if task.created_at }}"
        >
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold task-title">{{ task.title }}</div>
              <p class="text-muted mb-2 small task-description">
                {{ task.description or 'No description' }}
              </p>
            </div>
            <small class="text-muted ms-3 task-created-time">{{ task.created_at.strftime('%Y-%m-%d %H:%M') if task.created_at }}</small>
          </div>
          <div class="d-flex flex-wrap align-items-center gap-2">
            <span class="badge text-uppercase task-status-badge" data-status="{{ task.status }}">
              {{ 'Done' if task.status == 'done' else 'Pending' }}
            </span>
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary"
              data-bs-toggle="modal"
              data-bs-target="#editTaskModal"
              data-action="edit"
            >
              <i class="bi bi-pencil-square me-1"></i>
              Edit
            </button>
            <div class="mark-done-container {% if task.status == 'done' %}d-none{% endif %}">
              <button type="button" class="btn btn-sm btn-outline-success" data-action="toggle-done">
                <span class="spinner-border spinner-border-sm me-1 d-none" role="status" aria-hidden="true"></span>
                <span class="button-text">
                  <i class="bi bi-check2 me-1"></i>
                  Mark as done
                </span>
              </button>
            </div>
            <button
              type="button"
              class="btn btn-sm btn-outline-danger"
              data-bs-toggle="modal"
              data-bs-target="#deleteTaskModal"
              data-action="delete"
            >
              <i class="bi bi-trash me-1"></i>
              Delete
            </button>
          </div>
        </div>
        {% endfor %}
      </div>
      <div class="card-body {% if tasks %}d-none{% endif %}" id="emptyState">
        <p class="text-muted mb-0">No tasks to display. Try adjusting your filters or add a new task.</p>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="editTaskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editTaskForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="editTaskTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="editTaskTitle" name="title" required />
          </div>
          <div class="mb-3">
            <label for="editTaskDescription" class="form-label">Description</label>
            <textarea class="form-control" id="editTaskDescription" name="description" rows="3"></textarea>
          </div>
          <div class="mb-0">
            <label for="editTaskStatus" class="form-label">Status</label>
            <select class="form-select" id="editTaskStatus" name="status">
              <option value="pending">Pending</option>
              <option value="done">Done</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="saveTaskButton">
            <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
            <span class="button-text">Save changes</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">Are you sure you want to delete this task?</p>
        <p class="fw-semibold mt-2" id="deleteTaskTitle"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteButton">
          <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
          <span class="button-text">Delete</span>
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const editModalElement = document.getElementById("editTaskModal");
      const deleteModalElement = document.getElementById("deleteTaskModal");
      const editModal = editModalElement ? bootstrap.Modal.getOrCreateInstance(editModalElement) : null;
      const deleteModal = deleteModalElement ? bootstrap.Modal.getOrCreateInstance(deleteModalElement) : null;
      const editForm = document.getElementById("editTaskForm");
      const editTitleInput = document.getElementById("editTaskTitle");
      const editDescriptionInput = document.getElementById("editTaskDescription");
      const editStatusSelect = document.getElementById("editTaskStatus");
      const saveTaskButton = document.getElementById("saveTaskButton");
      const deleteTaskTitle = document.getElementById("deleteTaskTitle");
      const confirmDeleteButton = document.getElementById("confirmDeleteButton");
      const tasksList = document.getElementById("tasksList");
      const emptyState = document.getElementById("emptyState");
      const searchInput = document.getElementById("taskSearchInput");
      const statusFilter = document.getElementById("taskStatusFilter");

      let currentTaskId = null;
      const filterState = {
        query: "",
        status: "all",
      };

      function debounce(fn, delay = 300) {
        let timeoutId;
        return (...args) => {
          window.clearTimeout(timeoutId);
          timeoutId = window.setTimeout(() => fn.apply(null, args), delay);
        };
      }

      function toggleButtonLoading(button, isLoading) {
        if (!button) return;
        const spinner = button.querySelector(".spinner-border");
        const text = button.querySelector(".button-text");
        if (spinner) {
          spinner.classList.toggle("d-none", !isLoading);
        }
        if (text) {
          text.classList.toggle("d-none", isLoading);
        }
        button.disabled = isLoading;
      }

      function updateListVisibility() {
        if (!tasksList || !emptyState) return;
        const visibleItems = tasksList.querySelectorAll(".task-item:not(.d-none)").length;
        tasksList.classList.toggle("d-none", visibleItems === 0);
        emptyState.classList.toggle("d-none", visibleItems !== 0);
      }

      function updateRelativeTimeForTask(taskElement) {
        if (!taskElement) return;
        const timeElement = taskElement.querySelector(".task-created-time");
        if (!timeElement) return;
        const createdAt = taskElement.dataset.taskCreatedAt;
        if (!createdAt) {
          timeElement.textContent = "";
          return;
        }
        if (typeof dayjs === "undefined" || typeof dayjs().fromNow !== "function") {
          return;
        }
        const parsed = dayjs(createdAt);
        if (!parsed.isValid()) {
          return;
        }
        timeElement.textContent = parsed.fromNow();
      }

      function updateRelativeTimes() {
        if (!tasksList) return;
        tasksList.querySelectorAll(".task-item").forEach((taskElement) => {
          updateRelativeTimeForTask(taskElement);
        });
      }

      function hydrateTaskData(taskElement, data) {
        if (!taskElement) return;
        taskElement.dataset.taskTitle = data.title || "";
        taskElement.dataset.taskDescription = data.description || "";
        taskElement.dataset.taskStatus = data.status || "pending";
        if (data.created_at) {
          taskElement.dataset.taskCreatedAt = data.created_at;
        }

        const titleElement = taskElement.querySelector(".task-title");
        const descriptionElement = taskElement.querySelector(".task-description");
        const badgeElement = taskElement.querySelector(".task-status-badge");
        const markDoneContainer = taskElement.querySelector(".mark-done-container");

        if (titleElement) {
          titleElement.textContent = data.title;
        }
        if (descriptionElement) {
          descriptionElement.textContent = data.description || "No description";
        }
        if (badgeElement) {
          const statusValue = data.status === "done" ? "done" : "pending";
          badgeElement.textContent = statusValue === "done" ? "Done" : "Pending";
          badgeElement.setAttribute("data-status", statusValue);
        }
        if (markDoneContainer) {
          markDoneContainer.classList.toggle("d-none", data.status === "done");
        }

        updateRelativeTimeForTask(taskElement);
      }

      function applyFilters() {
        if (!tasksList) return;
        const normalizedQuery = filterState.query.trim().toLowerCase();
        const statusFilterValue = filterState.status;
        tasksList.querySelectorAll(".task-item").forEach((taskElement) => {
          const title = (taskElement.dataset.taskTitle || "").toLowerCase();
          const description = (taskElement.dataset.taskDescription || "").toLowerCase();
          const status = taskElement.dataset.taskStatus || "pending";
          const matchesQuery =
            !normalizedQuery ||
            title.includes(normalizedQuery) ||
            description.includes(normalizedQuery);
          const matchesStatus = statusFilterValue === "all" || status === statusFilterValue;
          const shouldShow = matchesQuery && matchesStatus;
          taskElement.classList.toggle("d-none", !shouldShow);
        });
        updateListVisibility();
      }

      document.querySelectorAll(".task-item [data-action='edit']").forEach((button) => {
        button.addEventListener("click", (event) => {
          const taskElement = event.currentTarget.closest(".task-item");
          if (!taskElement) return;
          currentTaskId = taskElement.dataset.taskId;
          editTitleInput.value = taskElement.dataset.taskTitle || "";
          editDescriptionInput.value = taskElement.dataset.taskDescription || "";
          editStatusSelect.value = taskElement.dataset.taskStatus || "pending";
        });
      });

      document.querySelectorAll(".task-item [data-action='delete']").forEach((button) => {
        button.addEventListener("click", (event) => {
          const taskElement = event.currentTarget.closest(".task-item");
          if (!taskElement) return;
          currentTaskId = taskElement.dataset.taskId;
          deleteTaskTitle.textContent = taskElement.dataset.taskTitle || "";
        });
      });

      document.querySelectorAll(".task-item [data-action='toggle-done']").forEach((button) => {
        button.addEventListener("click", async (event) => {
          const taskElement = event.currentTarget.closest(".task-item");
          if (!taskElement) return;
          const taskId = taskElement.dataset.taskId;
          const toggleButton = event.currentTarget;
          toggleButtonLoading(toggleButton, true);
          try {
            const response = await fetch(`/api/tasks/${taskId}/toggle_done`, {
              method: "POST",
            });
            let data = null;
            try {
              data = await response.json();
            } catch (parseError) {
              window.todoApp?.showAlert("Unexpected response from the server.", "danger");
              return;
            }
            if (!response.ok || !data.ok) {
              const message = data?.error || "Failed to update the task.";
              window.todoApp?.showAlert(message, "danger");
              return;
            }
            hydrateTaskData(taskElement, data.task);
            applyFilters();
            const statusMessage =
              data.status === "done" ? "Task marked as done!" : "Task marked as pending.";
            window.todoApp?.showAlert(statusMessage, "success");
          } catch (error) {
            window.todoApp?.showAlert("Network error. Please try again.", "danger");
          } finally {
            toggleButtonLoading(toggleButton, false);
          }
        });
      });

      if (editForm) {
        editForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (!currentTaskId) return;
          toggleButtonLoading(saveTaskButton, true);
          try {
            const response = await fetch(`/api/tasks/${currentTaskId}/update`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                title: editTitleInput.value,
                description: editDescriptionInput.value,
                status: editStatusSelect.value,
              }),
            });
            let data = null;
            try {
              data = await response.json();
            } catch (parseError) {
              window.todoApp?.showAlert("Unexpected response from the server.", "danger");
              return;
            }
            if (!response.ok || !data.ok) {
              const message = data.error || "Failed to update the task.";
              window.todoApp?.showAlert(message, "danger");
              return;
            }
            const taskElement = document.querySelector(`.task-item[data-task-id='${currentTaskId}']`);
            hydrateTaskData(taskElement, data.task);
            applyFilters();
            window.todoApp?.showAlert("Task updated successfully!", "success");
            editModal?.hide();
            currentTaskId = null;
          } catch (error) {
            window.todoApp?.showAlert("Network error. Please try again.", "danger");
          } finally {
            toggleButtonLoading(saveTaskButton, false);
          }
        });
      }

      if (confirmDeleteButton) {
        confirmDeleteButton.addEventListener("click", async () => {
          if (!currentTaskId) return;
          toggleButtonLoading(confirmDeleteButton, true);
          try {
            const response = await fetch(`/api/tasks/${currentTaskId}/delete`, {
              method: "POST",
            });
            let data = null;
            try {
              data = await response.json();
            } catch (parseError) {
              window.todoApp?.showAlert("Unexpected response from the server.", "danger");
              return;
            }
            if (!response.ok || !data.ok) {
              const message = data.error || "Failed to delete the task.";
              window.todoApp?.showAlert(message, "danger");
              return;
            }
            const taskElement = document.querySelector(`.task-item[data-task-id='${currentTaskId}']`);
            if (taskElement) {
              taskElement.remove();
              applyFilters();
            }
            window.todoApp?.showAlert("Task deleted.", "info");
            deleteModal?.hide();
            currentTaskId = null;
          } catch (error) {
            window.todoApp?.showAlert("Network error. Please try again.", "danger");
          } finally {
            toggleButtonLoading(confirmDeleteButton, false);
          }
        });
      }

      if (searchInput) {
        const handleSearch = debounce((event) => {
          filterState.query = event.target.value || "";
          applyFilters();
        });
        searchInput.addEventListener("input", handleSearch);
      }

      if (statusFilter) {
        statusFilter.addEventListener("change", (event) => {
          filterState.status = event.target.value || "all";
          applyFilters();
        });
      }

      if (searchInput) {
        filterState.query = searchInput.value || "";
      }
      if (statusFilter) {
        filterState.status = statusFilter.value || "all";
      }

      applyFilters();
      updateRelativeTimes();
      window.setInterval(updateRelativeTimes, 60000);
    });
  </script>
{% endblock %}
